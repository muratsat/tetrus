<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tetrus</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-100">
    <div
      id="error"
      class="w-full p-4 flex flex-col items-center justify-center"
      style="display: none"
    >
      <div
        class="w-full max-w-md bg-red-50 p-4 rounded-lg shadow-md flex flex-col gap-1"
      >
        <h1 class="text-xl font-bold">Error</h1>
        <p id="errorMessage"></p>
      </div>
    </div>
    <main id="gui" class="p-4 min-h-[100dvh]" style="display: none">
      <h1 class="text-3xl font-bold mb-4 text-center">TetrUs</h1>
      <div class="flex flex-col lg:flex-row gap-4">
        <!-- Players List -->
        <div
          class="w-full lg:w-1/4 bg-white p-4 rounded-lg shadow-md flex flex-col gap-3"
        >
          <h2 class="text-xl font-semibold mb-2">Players</h2>
          <ul id="playersList" class="space-y-3 flex-grow overflow-y-auto">
            <!-- Players will be added here dynamically -->
          </ul>
          <form id="editUsername" class="flex">
            <input
              type="text"
              id="username"
              class="flex-grow border rounded-l px-2 py-1 disabled:text-gray-400"
              placeholder="Username"
            />
            <button
              type="submit"
              class="bg-blue-500 text-white px-4 py-1 rounded-r disabled:bg-gray-500"
            >
              Change
            </button>
          </form>
          <form id="readyForm" class="flex">
            <button
              id="readyButton"
              class="bg-blue-500 text-white px-4 py-1 w-full rounded"
            >
              Ready
            </button>
          </form>
        </div>

        <!-- Game Canvas -->
        <div
          class="w-full lg:w-1/2 bg-white p-4 rounded-lg shadow-md flex justify-center items-center"
        >
          <canvas
            id="tetrisCanvas"
            width="300"
            height="600"
            class="border border-gray-300"
          ></canvas>
        </div>

        <!-- Chat -->
        <div
          class="w-full lg:w-1/4 bg-white p-4 rounded-lg shadow-md flex flex-col"
        >
          <h2 class="text-xl font-semibold mb-2">Chat</h2>
          <div
            id="chatMessages"
            class="flex-grow overflow-y-auto mb-2 space-y-2"
          >
            <!-- Chat messages will be added here dynamically -->
          </div>
          <form class="flex" id="chatForm">
            <input
              type="text"
              id="chatInput"
              class="flex-grow border rounded-l px-2 py-1"
              placeholder="Type a message..."
            />
            <button
              type="submit"
              class="bg-blue-500 text-white px-4 py-1 rounded-r"
            >
              Send
            </button>
          </form>
        </div>
      </div>
    </main>

    <pre
      id="game-state"
      class="w-full lg:w-1/2 bg-white p-4 rounded-lg shadow-md flex justify-center items-center"
    ></pre>

    <script>
      const players = new Map();
      let myId = null;

      function setPlayer({ id, username, ready }) {
        const prev = players.get(id);
        players.set(id, { id, username, ready });
      }

      function setCountDown(seconds) {
        const modal = document.getElementById("countdown-modal");
        modal.style.display = "flex";
        const countdownText = document.getElementById("countdown-text");
        countdownText.innerHTML = seconds;
        if (seconds === 1) {
          setTimeout(() => {
            modal.style.display = "none";
          }, 1000);
        }
      }

      function renderPlayersList() {
        const list = document.getElementById("playersList");
        list.innerHTML = "";
        players.forEach((player, id) => {
          const li = document.createElement("li");
          li.className = "flex justify-between items-center";
          const imgUrl = `https://nft-avatars.fly.dev/${player.username}`;
          const label = `${player.username} ${
            player.id === myId ? "<b> (You)</b>" : ""
          }`;

          li.innerHTML = `
            <div class="flex items-center gap-2">
              <img src=${imgUrl} class="w-10 h-10 rounded-full bg-gray-200" />
              <span>${label}</span>
            </div>
            <span 
              class="${player.ready ? "text-green-500" : "text-red-500"}">
              ${player.ready ? "Ready" : "Not Ready"}
            </span>
                `;
          list.appendChild(li);
        });
      }

      function addChatMessage(username, message) {
        const div = document.createElement("div");
        div.className = "bg-gray-100 p-2 rounded flex flex-col gap-1";
        const imgUrl = `https://nft-avatars.fly.dev/${username}`;
        div.innerHTML = `
          <div class="flex items-center gap-2">
            <img src=${imgUrl} class="w-8 h-8 rounded-full bg-gray-200" />
            <strong>${username}</strong>
          </div>
          <p class="text-lg ml-10">${message}</p>
        `;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function handleServerMessage(msg) {
        // console.log("Server:", msg);
        switch (msg.type) {
          case "welcome":
            document.getElementById("username").value = msg.data.username;
            myId = msg.data.client_id;
            msg.data.players.forEach((player) =>
              setPlayer({
                id: player.id,
                username: player.username,
                ready: player.ready,
              })
            );
            renderPlayersList();
            break;
          case "player_connected":
            setPlayer({
              id: msg.data.id,
              username: msg.data.username,
              ready: msg.data.ready,
            });
            renderPlayersList();
            break;
          case "player_disconnected":
            players.delete(msg.data.client_id);
            renderPlayersList();
            break;
          case "player_updated":
            setPlayer({
              id: msg.data.id,
              username: msg.data.username,
              ready: msg.data.ready,
            });
            renderPlayersList();
            break;
          case "chat_message":
            addChatMessage(msg.data.username, msg.data.message_text);
            break;
          case "countdown":
            setCountDown(msg.data.count);
            break;
          case "state_update":
            // console.log(JSON.stringify(msg.data, null, 2));
            document.getElementById("game-state").innerHTML = JSON.stringify(
              msg.data,
              null,
              2
            );
            break;
          case "game_over":
            console.log("Game over", msg.data.players);
            msg.data.players.forEach((player) =>
              setPlayer({
                id: player.id,
                username: player.username,
                ready: player.ready,
              })
            );
            renderPlayersList();
            break;
        }
      }

      function initWebSocket() {
        const url = "ws://" + window.location.host + "/ws";
        const socket = new WebSocket("/ws");
        socket.onopen = (event) => {
          console.log("Connected to websocket");
          document.getElementById("gui").style.display = "block";
        };

        socket.onmessage = (event) => {
          try {
            const msg = JSON.parse(event.data);
            handleServerMessage(msg);
          } catch (error) {
            console.error("Error parsing message:", error);
          }
        };
        socket.onclose = (event) => {
          document.getElementById("gui").style.display = "none";
          document.getElementById("errorMessage").innerHTML =
            "Connection to websocket closed<br>Please refresh the page";
          document.getElementById("error").style.display = "flex";
        };
        return socket;
      }

      function main() {
        const socket = initWebSocket();

        const editUser = ({ username, ready }) => {
          socket.send(
            JSON.stringify({
              type: "edit_user",
              data: {
                username,
                ready,
              },
            })
          );
        };

        document
          .getElementById("readyForm")
          .addEventListener("submit", (event) => {
            event.preventDefault();
            const me = players.get(myId);
            editUser({ ready: !me.ready, username: me.username });
          });

        document
          .getElementById("editUsername")
          .addEventListener("submit", (event) => {
            event.preventDefault();
            const username = document.getElementById("username").value;
            editUser({ username, ready: false });
          });

        document
          .getElementById("chatForm")
          .addEventListener("submit", (event) => {
            event.preventDefault();
            const chatInput = document.getElementById("chatInput");
            const messageText = chatInput.value;
            console.log(messageText);
            if (messageText !== "")
              socket.send(
                JSON.stringify({
                  type: "chat_message",
                  data: {
                    message_text: messageText,
                  },
                })
              );
            chatInput.value = "";
          });

        document.addEventListener("keydown", (event) => {
          const registeredKeys = [
            "ArrowUp",
            "ArrowDown",
            "ArrowLeft",
            "ArrowRight",
            // " ",
            // "z",
            // "x",
          ];

          if (registeredKeys.includes(event.key)) {
            socket.send(
              JSON.stringify({ type: "move", data: { direction: event.key } })
            );
          }
        });
      }

      document.addEventListener("DOMContentLoaded", main);
    </script>
    <div
      id="countdown-modal"
      style="display: none"
      class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex justify-center items-center z-50"
    >
      <div class="bg-white rounded-md p-4 shadow-lg flex flex-col gap-2">
        <h1 class="text-xl font-bold">Game stars in</h1>
        <div class="flex flex-row items-center gap-2">
          <span id="countdown-text" class="text-3xl font-bold"></span>
          <span class="text-xl font-bold">seconds</span>
        </div>
      </div>
    </div>
  </body>
</html>
